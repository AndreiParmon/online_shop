// theme.js - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ¼Ð½Ð¾Ð¹ Ñ‚ÐµÐ¼Ð¾Ð¹ (Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)

document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¨ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚ÐµÐ¼Ñ‹...');

    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ transition Ð´Ð»Ñ Ð¿Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°
    document.documentElement.style.transition = 'all 0.3s ease';
    document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»Ð¸
    const themeToggle = document.getElementById('theme-toggle');
    const themeToggleMobile = document.getElementById('theme-toggle-mobile');

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ Ð¸Ð»Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    let currentTheme = localStorage.getItem('klimiron_theme');

    // Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ¼Ð° Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
    if (!currentTheme) {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            currentTheme = 'dark';
        } else {
            currentTheme = 'light';
        }
        localStorage.setItem('klimiron_theme', currentTheme);
    }

    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐ¼Ñƒ
    setTheme(currentTheme);

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }

    if (themeToggleMobile) {
        themeToggleMobile.addEventListener('click', function(e) {
            e.preventDefault();
            toggleTheme();
        });
    }

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ñ‚ÐµÐ¼Ñ‹ Ð² Ñ„ÑƒÑ‚ÐµÑ€Ðµ
    updateThemeLabel(currentTheme);

    console.log('âœ… Ð¢ÐµÐ¼Ð° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°:', currentTheme);
});

function setTheme(theme) {
    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ data-Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚ Ð½Ð° html
    document.documentElement.setAttribute('data-theme', theme);

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² localStorage
    localStorage.setItem('klimiron_theme', theme);

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»Ñ
    updateToggleState(theme === 'dark');

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸ÐºÐ¾Ð½ÐºÐ¸
    updateIcons(theme);

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð² Ñ„ÑƒÑ‚ÐµÑ€Ðµ
    updateThemeLabel(theme);

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð°ÑÑ Ð´Ð»Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸
    document.documentElement.classList.add('theme-transition');
    setTimeout(() => {
        document.documentElement.classList.remove('theme-transition');
    }, 300);
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
    document.documentElement.style.opacity = '0.9';

    setTimeout(() => {
        setTheme(newTheme);
        document.documentElement.style.opacity = '1';
    }, 150);

    console.log('ðŸ”„ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð° Ñ‚ÐµÐ¼Ð°:', newTheme);
}

function updateToggleState(isDark) {
    const toggle = document.getElementById('theme-toggle');
    const mobileToggle = document.getElementById('theme-toggle-mobile');

    if (toggle) {
        if (isDark) {
            toggle.setAttribute('aria-label', 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ²ÐµÑ‚Ð»ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ');
            toggle.setAttribute('title', 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ²ÐµÑ‚Ð»ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ');
        } else {
            toggle.setAttribute('aria-label', 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ');
            toggle.setAttribute('title', 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ');
        }
    }
}

function updateIcons(theme) {
    const mobileToggle = document.getElementById('theme-toggle-mobile');

    if (mobileToggle) {
        const icon = mobileToggle.querySelector('i');
        const text = mobileToggle.querySelector('span');

        if (icon && text) {
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
                text.textContent = 'Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ Ñ‚ÐµÐ¼Ð°';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = 'Ð¢Ñ‘Ð¼Ð½Ð°Ñ Ñ‚ÐµÐ¼Ð°';
            }
        }
    }
}

function updateThemeLabel(theme) {
    const themeLabel = document.getElementById('current-theme-label');
    if (themeLabel) {
        themeLabel.textContent = theme === 'dark' ? 'Ð¢Ñ‘Ð¼Ð½Ð°Ñ' : 'Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ';
    }
}

// Ð¡Ð»ÑƒÑˆÐ°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¹ Ñ‚ÐµÐ¼Ñ‹
if (window.matchMedia) {
    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');

    colorSchemeQuery.addEventListener('change', function(e) {
        // ÐœÐµÐ½ÑÐµÐ¼ Ñ‚ÐµÐ¼Ñƒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð´ÐµÐ»Ð°Ð» Ð²Ñ‹Ð±Ð¾Ñ€ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
        const savedTheme = localStorage.getItem('klimiron_theme');
        if (!savedTheme) {
            const newTheme = e.matches ? 'dark' : 'light';
            setTheme(newTheme);
            console.log('ðŸŒ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð°Ñ Ñ‚ÐµÐ¼Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð°:', newTheme);
        }
    });
}

// Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
window.themeManager = {
    toggleTheme,
    setTheme,
    getTheme: () => document.documentElement.getAttribute('data-theme') || 'light'
};